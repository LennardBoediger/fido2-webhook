// Copyright 2019 SoloKeys Developers
//
// Licensed under the Apache License, Version 2.0, <LICENSE-APACHE or
// http://apache.org/licenses/LICENSE-2.0> or the MIT license <LICENSE-MIT or
// http://opensource.org/licenses/MIT>, at your option. This file may not be
// copied, modified, or distributed except according to those terms.
#include <stdint.h>
#include <string.h>
#include "crypto.h"
#include "memory_layout.h"
#include "device.h"
#include "sense.h"
#include "log.h"

const uint8_t attestation_solo_cert_der[] =
"\x30\x82\x02\x50\x30\x82\x01\xf5\xa0\x03\x02\x01\x02\x02\x01\x01\x30\x0a\x06\x08"
"\x2a\x86\x48\xce\x3d\x04\x03\x02\x30\x4e\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13"
"\x02\x44\x45\x31\x16\x30\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b"
"\x65\x79\x20\x47\x6d\x62\x48\x31\x10\x30\x0e\x06\x03\x55\x04\x0b\x0c\x07\x52\x6f"
"\x6f\x74\x20\x43\x41\x31\x15\x30\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72"
"\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x30\x20\x17\x0d\x31\x39\x31\x32\x30\x34\x30\x37"
"\x33\x36\x31\x30\x5a\x18\x0f\x32\x30\x36\x39\x31\x31\x32\x31\x30\x37\x33\x36\x31"
"\x30\x5a\x30\x60\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x44\x45\x31\x16\x30"
"\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b\x65\x79\x20\x47\x6d\x62"
"\x48\x31\x22\x30\x20\x06\x03\x55\x04\x0b\x0c\x19\x41\x75\x74\x68\x65\x6e\x74\x69"
"\x63\x61\x74\x6f\x72\x20\x41\x74\x74\x65\x73\x74\x61\x74\x69\x6f\x6e\x31\x15\x30"
"\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d"
"\x30\x59\x30\x13\x06\x07\x2a\x86\x48\xce\x3d\x02\x01\x06\x08\x2a\x86\x48\xce\x3d"
"\x03\x01\x07\x03\x42\x00\x04\xb6\xa8\x02\x1d\x09\xdd\x48\x8f\x31\xdb\xe3\x7e\x26"
"\xd6\xcd\xa5\x44\x11\xc3\x34\x27\x93\x20\x6e\x51\x0a\x0c\x7f\x2c\xc8\x87\xb9\xa7"
"\x3c\x4a\xb4\x64\x2a\xb7\x8c\xa1\xd8\xc3\x80\x9f\x71\x2c\xc2\x9a\x73\x5d\xef\x2d"
"\xa4\x66\x25\xa0\x3a\xcf\x49\x6b\xd2\x02\x87\xa3\x81\xaf\x30\x81\xac\x30\x1d\x06"
"\x03\x55\x1d\x0e\x04\x16\x04\x14\x2e\x5b\x45\x7e\x56\x10\xb4\xe5\xdd\xb4\xa9\x28"
"\x0b\xd1\x1f\xe8\xfe\xe5\xc6\x46\x30\x73\x06\x03\x55\x1d\x23\x04\x6c\x30\x6a\xa1"
"\x52\xa4\x50\x30\x4e\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x44\x45\x31\x16"
"\x30\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b\x65\x79\x20\x47\x6d"
"\x62\x48\x31\x10\x30\x0e\x06\x03\x55\x04\x0b\x0c\x07\x52\x6f\x6f\x74\x20\x43\x41"
"\x31\x15\x30\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e"
"\x63\x6f\x6d\x82\x14\x16\x62\x04\x96\xe9\xd9\xf4\xff\x2d\xa4\x49\xf1\x7c\x25\xf6"
"\xa8\x57\xeb\x66\xe8\x30\x09\x06\x03\x55\x1d\x13\x04\x02\x30\x00\x30\x0b\x06\x03"
"\x55\x1d\x0f\x04\x04\x03\x02\x04\xf0\x30\x0a\x06\x08\x2a\x86\x48\xce\x3d\x04\x03"
"\x02\x03\x49\x00\x30\x46\x02\x21\x00\xbd\x3c\x0a\x08\xf1\x6b\x5b\x26\x16\xb8\x65"
"\x7f\x9b\xbb\x2e\x1d\x06\xc3\x95\x6f\xb9\x84\xce\xab\xec\x56\x70\x0e\x0a\x20\xc4"
"\xff\x02\x21\x00\x9f\x6d\x46\xd6\xb6\x8e\x99\x6f\xe5\xe7\x2e\xc1\xce\xdd\x29\xe1"
"\x33\x1b\xf1\x4e\x40\x3d\xe3\x83\x5f\x69\x57\xb7\x70\xad\xe6\x07"
;

const uint8_t attestation_hacker_cert_der[] =
"\x30\x82\x02\xd6\x30\x82\x02\x7d\xa0\x03\x02\x01\x02\x02\x01\x01\x30\x0a\x06\x08"
"\x2a\x86\x48\xce\x3d\x04\x03\x02\x30\x7a\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13"
"\x02\x44\x45\x31\x1b\x30\x19\x06\x03\x55\x04\x0a\x0c\x12\x4e\x69\x74\x72\x6f\x6b"
"\x65\x79\x20\x47\x6d\x62\x48\x20\x54\x45\x53\x54\x31\x10\x30\x0e\x06\x03\x55\x04"
"\x0b\x0c\x07\x52\x6f\x6f\x74\x20\x43\x41\x31\x1a\x30\x18\x06\x03\x55\x04\x03\x0c"
"\x11\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x20\x54\x45\x53\x54\x31\x20"
"\x30\x1e\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x09\x01\x16\x11\x69\x6e\x66\x6f\x40"
"\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x30\x20\x17\x0d\x31\x39\x31\x32"
"\x30\x33\x31\x37\x31\x38\x33\x34\x5a\x18\x0f\x32\x30\x36\x39\x31\x31\x32\x30\x31"
"\x37\x31\x38\x33\x34\x5a\x30\x81\x8c\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02"
"\x44\x45\x31\x1b\x30\x19\x06\x03\x55\x04\x0a\x0c\x12\x4e\x69\x74\x72\x6f\x6b\x65"
"\x79\x20\x47\x6d\x62\x48\x20\x54\x45\x53\x54\x31\x22\x30\x20\x06\x03\x55\x04\x0b"
"\x0c\x19\x41\x75\x74\x68\x65\x6e\x74\x69\x63\x61\x74\x6f\x72\x20\x41\x74\x74\x65"
"\x73\x74\x61\x74\x69\x6f\x6e\x31\x1a\x30\x18\x06\x03\x55\x04\x03\x0c\x11\x6e\x69"
"\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x20\x54\x45\x53\x54\x31\x20\x30\x1e\x06"
"\x09\x2a\x86\x48\x86\xf7\x0d\x01\x09\x01\x16\x11\x69\x6e\x66\x6f\x40\x6e\x69\x74"
"\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x30\x59\x30\x13\x06\x07\x2a\x86\x48\xce\x3d"
"\x02\x01\x06\x08\x2a\x86\x48\xce\x3d\x03\x01\x07\x03\x42\x00\x04\xac\xba\x04\x3d"
"\x33\x1d\xda\x29\xe5\x3d\x76\xa9\x65\x55\xfb\xa6\x1a\x52\xcf\x64\x86\x78\x0e\x63"
"\x7c\x61\xbb\x3c\x54\x14\x91\xb0\x55\xe6\x1d\xa2\x5d\x1e\x9e\xbd\x8e\x5b\x89\x40"
"\x35\xbe\x3c\x67\x9e\x71\x22\x4a\x3f\xe0\x04\xac\x8a\x77\xe9\x9d\x91\xa4\x9e\x2f"
"\xa3\x81\xde\x30\x81\xdb\x30\x1d\x06\x03\x55\x1d\x0e\x04\x16\x04\x14\x0a\xcd\x9c"
"\x0e\xae\x8a\xa5\xb9\xb1\x4d\x31\x3c\x19\x5e\x23\x1d\x80\xbe\xe7\x03\x30\x81\xa1"
"\x06\x03\x55\x1d\x23\x04\x81\x99\x30\x81\x96\xa1\x7e\xa4\x7c\x30\x7a\x31\x0b\x30"
"\x09\x06\x03\x55\x04\x06\x13\x02\x44\x45\x31\x1b\x30\x19\x06\x03\x55\x04\x0a\x0c"
"\x12\x4e\x69\x74\x72\x6f\x6b\x65\x79\x20\x47\x6d\x62\x48\x20\x54\x45\x53\x54\x31"
"\x10\x30\x0e\x06\x03\x55\x04\x0b\x0c\x07\x52\x6f\x6f\x74\x20\x43\x41\x31\x1a\x30"
"\x18\x06\x03\x55\x04\x03\x0c\x11\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d"
"\x20\x54\x45\x53\x54\x31\x20\x30\x1e\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x09\x01"
"\x16\x11\x69\x6e\x66\x6f\x40\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x82"
"\x14\x32\x17\xfd\xcc\xf9\xf0\xd0\xe3\x6a\xe4\xd1\xe8\x59\x68\x67\x64\x02\x4b\xba"
"\x89\x30\x09\x06\x03\x55\x1d\x13\x04\x02\x30\x00\x30\x0b\x06\x03\x55\x1d\x0f\x04"
"\x04\x03\x02\x04\xf0\x30\x0a\x06\x08\x2a\x86\x48\xce\x3d\x04\x03\x02\x03\x47\x00"
"\x30\x44\x02\x20\x78\x94\xe8\x14\xdc\x4a\xcc\xce\x07\x8c\x42\xdf\x0d\xef\x77\x43"
"\xd8\xe3\xb7\x35\x4c\xc0\x42\x4a\xef\x4d\x1a\x0a\x69\x9e\xce\x99\x02\x20\x1a\xde"
"\x83\x9b\xe3\x0c\x68\x30\xff\x38\xbe\x73\x79\xe2\xbe\x26\x1b\x80\xe5\xce\xa3\xdf"
"\x90\xde\x10\x4e\x4b\xb1\x62\x90\xdd\xf7"
;


const uint16_t attestation_solo_cert_der_size = sizeof(attestation_solo_cert_der)-1;
const uint16_t attestation_hacker_cert_der_size = sizeof(attestation_hacker_cert_der)-1;

uint8_t solo_hacker_attestation_key[32] = "\xfc\x02\x52\xbe\x0c\xb6\x80\xc0\x4c\xc3"
                                          "\x45\xb9\x2b\x2e\x47\xe0\x8c\xde\x36\x03"
                                          "\xdf\x53\x8c\xb0\xf9\x6f\xc3\xf2\x88\x50"
                                          "\x45\xf5";

// const uint16_t attestation_key_size = 32;
const uint8_t * attestation_cert_der = ((flash_attestation_page *)ATTESTATION_PAGE_ADDR)->attestation_cert;

uint8_t * device_get_attestation_key(){
    flash_attestation_page * page =(flash_attestation_page *)ATTESTATION_PAGE_ADDR;
    return page->attestation_key;
}

uint16_t device_attestation_cert_der_get_size(){
    uint16_t sz = (uint16_t)((flash_attestation_page *)ATTESTATION_PAGE_ADDR)->attestation_cert_size;
    return sz;
}

void device_attestation_read_cert_der(uint8_t * dst){
    const uint8_t * der = ((flash_attestation_page *)ATTESTATION_PAGE_ADDR)->attestation_cert;
    uint16_t sz = device_attestation_cert_der_get_size();
    memmove(dst, der, sz);
}

const uint8_t global_aaguid[16] = "\xc3\x9e\xfb\xa6\xfc\xf4\x4c\x3e\x82\x8b\xfc\x4a\x61\x15\xa0\xff";
